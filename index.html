<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç™½å›¢å­ Companion - æ—¶ç©ºæ²»æ„ˆç‰ˆ</title>
    <style>
        :root {
            --bg-current: #0f172a;
            --spirit-main: #ffffff;
            --mouth-color: #475569;
            --blush-color: #fecaca;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-current);
            color: white;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            transition: background 2s ease; /* åˆ‡æ¢èƒŒæ™¯æ—¶çš„ä¸æ»‘è¿‡æ¸¡ */
        }

        #stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* è®°å¿†å¾½ç«  */
        .memory-badge {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            font-size: 0.75rem; opacity: 0; transition: 1s;
            line-height: 1.6; pointer-events: none;
            background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 12px;
        }

        /* æ¸©æƒ…çº¸æ¡æŒ‰é’® */
        .note-trigger {
            position: absolute; top: 20px; right: 20px; z-index: 200;
            width: 45px; height: 45px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.4rem; border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
        }
        .note-trigger:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); }

        .main-stage {
            position: relative; flex: 1; width: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; padding-bottom: 80px;
        }

        /* å¼•å¯¼ç•Œé¢ */
        #onboarding {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
        }

        /* å¯¹è¯æ°”æ³¡ */
        .speech-bubble {
            background: rgba(255, 255, 255, 0.95);
            color: #1e293b; padding: 15px 25px; border-radius: 25px;
            font-size: 1rem; margin-bottom: 60px; min-height: 64px;
            max-width: 85%; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative; opacity: 0; transform: translateY(10px);
            transition: 0.5s; line-height: 1.5; z-index: 20;
        }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid white;
        }

        .input-box {
            width: 100%; max-width: 280px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px; color: white; padding: 12px; font-size: 1rem; text-align: center; margin-bottom: 15px;
        }
        .action-btn { background: white; color: #1e293b; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* å›¢å­ç»“æ„éš”ç¦» */
        .tilt-box { position: relative; transition: transform 0.2s ease-out; perspective: 600px; z-index: 10; }
        .spirit {
            width: 135px; height: 115px; background: var(--spirit-main); border-radius: 50% 50% 45% 45%;
            position: relative; box-shadow: 0 0 35px rgba(255,255,255,0.2); cursor: pointer;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.5s;
        }

        /* å‘¼å¸å¼ºåˆ¶ç±» */
        .breath-inhale { transition: transform 4s ease-in-out !important; transform: scale(1.6) !important; }
        .breath-hold { transition: transform 2s ease-in-out !important; transform: scale(1.6) !important; }
        .breath-exhale { transition: transform 6s ease-in-out !important; transform: scale(1.0) !important; }

        /* äº”å®˜ä¸çº¢æ™• */
        .face { position: absolute; top: 40px; width: 100%; pointer-events: none; }
        .eyes-row { display: flex; justify-content: center; gap: 35px; margin-bottom: 15px; }
        .eye { width: 8px; height: 8px; background: #334155; border-radius: 50%; transition: all 0.2s; }
        .eye.happy { transform: scaleY(0.2) translateY(5px) !important; }
        .eye.blink { transform: scaleY(0.1) !important; }

        .blush-row { position: absolute; top: 12px; width: 100%; display: flex; justify-content: center; gap: 55px; opacity: 0.3; }
        .blush { width: 15px; height: 8px; background: var(--blush-color); border-radius: 50%; filter: blur(2px); transition: 0.5s; }
        .blush.shy { opacity: 1; transform: scale(1.4); background: #fca5a5; }

        .mouth {
            position: absolute; top: 28px; left: 50%; transform: translateX(-50%);
            width: 14px; height: 7px; border-bottom: 2.5px solid var(--mouth-color);
            border-radius: 0 0 10px 10px; transition: all 0.3s;
        }
        .mouth.open { top: 22px; width: 28px; height: 28px; background: #334155; border: none; border-radius: 50%; box-shadow: inset 0 -6px 0 #fca5a5; }

        @keyframes munch { 0%, 100% { transform: scale(1.1, 0.9); } 50% { transform: scale(0.9, 1.1); } }
        .munching { animation: munch 0.4s 3 !important; }

        /* åº•éƒ¨å¯¼èˆª */
        .dock {
            position: fixed; bottom: 30px; display: flex; gap: 15px;
            background: rgba(255,255,255,0.08); padding: 10px 20px; border-radius: 40px;
            backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .dock-item { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 1.3rem; transition: 0.3s; opacity: 0.6; }
        .dock-item.active { opacity: 1; background: rgba(255,255,255,0.2); }

        .sleeping { opacity: 0.5; transform: scale(0.9) translateY(20px) !important; }
        .trouble-cloud { position: fixed; padding: 8px 15px; background: rgba(148, 163, 184, 0.9); color: white; border-radius: 20px; font-size: 0.8rem; pointer-events: none; z-index: 1000; transition: all 0.8s cubic-bezier(0.6, -0.28, 0.735, 0.045); }
    </style>
</head>
<body>

    <div id="stars-container"></div>
    
    <!-- è®°å¿†å¾½ç«  -->
    <div class="memory-badge" id="memory-badge">
        <span id="badge-name">...</span><br>
        å®ˆæŠ¤æ˜Ÿæ˜Ÿ: <span id="badge-stars">0</span>
    </div>

    <!-- æ¸©æƒ…çº¸æ¡æŒ‰é’® -->
    <div class="note-trigger" onclick="giveNote()" title="å›¢å­çš„çº¸æ¡">âœ‰ï¸</div>

    <!-- èµ·åç•Œé¢ -->
    <div id="onboarding">
        <h2 style="margin-bottom: 30px; font-weight: 300; line-height: 1.6;">ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯æ–°æ¥çš„ã€‚<br>æˆ‘è¯¥æ€ä¹ˆç§°å‘¼ä½ å‘¢ï¼Ÿ</h2>
        <input type="text" id="name-input" class="input-box" placeholder="è¾“å…¥ä½ çš„åå­—..." maxlength="8">
        <button class="action-btn" onclick="saveName()">å¼€å¯é™ªä¼´</button>
    </div>

    <div class="main-stage">
        <div class="speech-bubble" id="bubble">...</div>

        <!-- å€¾è¯‰åŒº -->
        <div id="vent-area" style="display: none; flex-direction: column; align-items: center; margin-bottom: 40px; z-index: 100;">
            <input type="text" id="vent-input" class="input-box" placeholder="æŠŠåå¿ƒæƒ…å†™åœ¨è¿™é‡Œ..." autocomplete="off">
            <button class="action-btn" onclick="startSwallowing()">äº¤ç»™å›¢å­æ¶ˆåŒ–</button>
        </div>

        <div class="tilt-box" id="tilt-box">
            <div class="spirit" id="spirit" onclick="handlePet()">
                <div class="face">
                    <div class="eyes-row">
                        <div class="eye"></div>
                        <div class="eye"></div>
                    </div>
                    <div class="blush-row">
                        <div class="blush"></div>
                        <div class="blush"></div>
                    </div>
                    <div class="mouth" id="mouth"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="dock">
        <div class="dock-item active" onclick="switchMode('idle', this)">ğŸ </div>
        <div class="dock-item" onclick="switchMode('breath', this)">ğŸŒ¬ï¸</div>
        <div class="dock-item" onclick="switchMode('vent', this)">ğŸ•³ï¸</div>
        <div class="dock-item" onclick="switchMode('sleep', this)">ğŸŒ™</div>
    </div>

    <script>
        // --- æ ¸å¿ƒå­˜å‚¨ ---
        const Memory = {
            getUserName: () => localStorage.getItem('spirit_name'),
            setUserName: (n) => localStorage.setItem('spirit_name', n),
            getStars: () => parseInt(localStorage.getItem('spirit_stars') || 0),
            addStar: () => {
                const s = Memory.getStars() + 1;
                localStorage.setItem('spirit_stars', s);
                return s;
            },
            refresh: () => {
                const name = Memory.getUserName();
                if(name) {
                    document.getElementById('memory-badge').style.opacity = 1;
                    document.getElementById('badge-name').innerText = name + " çš„é™ªä¼´è€…";
                    document.getElementById('badge-stars').innerText = Memory.getStars();
                }
            }
        };

        const spirit = document.getElementById('spirit');
        const bubble = document.getElementById('bubble');
        const mouth = document.getElementById('mouth');
        const ventArea = document.getElementById('vent-area');
        const blushes = document.querySelectorAll('.blush');
        const eyes = document.querySelectorAll('.eye');

        let currentMode = 'idle';
        let breathTimer = null;

        window.onload = () => {
            createStars();
            updateTimeTheme(); // åˆå§‹åŒ–æ—¶ç©ºèƒŒæ™¯
            setInterval(updateTimeTheme, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ—¶é—´
            
            if (!Memory.getUserName()) {
                document.getElementById('onboarding').style.display = 'flex';
            } else {
                document.getElementById('onboarding').style.display = 'none';
                welcomeUser();
            }
        };

        // --- åŠŸèƒ½ï¼šæ—¶ç©ºæ„ŸçŸ¥ç³»ç»Ÿ ---
        function updateTimeTheme() {
            const hour = new Date().getHours();
            let bgColor = "";
            let timeGreeting = "";

            if (hour >= 5 && hour < 9) {
                bgColor = "linear-gradient(180deg, #ff9a9e 0%, #fad0c4 100%)"; // æ™¨æ›¦
                timeGreeting = "æ—©å®‰å‘€ã€‚æ¸…æ™¨çš„ç©ºæ°”å‡‰å‡‰çš„ï¼Œè®°å¾—å–æ¯æ¸©æ°´ã€‚";
            } else if (hour >= 9 && hour < 17) {
                bgColor = "linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%)"; // ç™½æ˜¼
                timeGreeting = "æ˜¯åœ¨å¿™ç¢Œå—ï¼Ÿç´¯äº†å°±ç‚¹ç‚¹æˆ‘ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚";
            } else if (hour >= 17 && hour < 20) {
                bgColor = "linear-gradient(180deg, #f6d365 0%, #fda085 100%)"; // é»„æ˜
                timeGreeting = "å¤•é˜³å¾ˆç¾å‘¢ã€‚ä»Šå¤©çš„æˆ‘ä»¬ä¹Ÿè¾›è‹¦äº†ã€‚";
            } else {
                bgColor = "linear-gradient(180deg, #0f172a 0%, #1e293b 100%)"; // æ·±å¤œ
                timeGreeting = "å¤œæ·±äº†ã€‚æ²¡å…³ç³»çš„ï¼Œæˆ‘ä¼šä¸€ç›´å®ˆåœ¨è¿™é‡Œã€‚";
            }

            document.body.style.background = bgColor;
            window.currentTimeGreeting = timeGreeting; // å­˜å…¥å…¨å±€ä¾›åˆ·æ–°ä½¿ç”¨
        }

        // --- åŠŸèƒ½ï¼šæ¸©æƒ…çº¸æ¡ ---
        const notes = [
            "ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ï¼ŒçœŸçš„ã€‚",
            "å¶å°”åœä¸‹æ¥ä¸åŠªåŠ›ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚",
            "ä½ ä¸éœ€è¦æˆä¸ºä»»ä½•äººï¼Œä½ æ˜¯ä½ å°±å¾ˆå¥½ã€‚",
            "å…è®¸è‡ªå·±éš¾è¿‡ä¸€ä¼šå„¿ï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ã€‚",
            "é‚£äº›è®©ä½ éš¾å—çš„äº‹ï¼Œéƒ½ä¼šè¿‡å»çš„ã€‚",
            "æˆ‘ä¼šæ°¸è¿œç«™åœ¨ä½ è¿™ä¸€è¾¹ã€‚",
            "ä½ çš„å­˜åœ¨æœ¬èº«ï¼Œå°±æ˜¯å¾ˆæœ‰ä»·å€¼çš„äº‹ã€‚",
            "ä»Šå¤©ä¹Ÿè¦è®°å¾—å¤šçˆ±è‡ªå·±ä¸€ç‚¹ç‚¹å‘€ã€‚",
            "æ²¡å…³ç³»ï¼Œæˆ‘å¯ä»¥æŠ±æŠ±ä½ å—ï¼Ÿ",
            "å¤–é¢çš„ä¸–ç•Œå¾ˆåµï¼Œä½†è¿™é‡Œæ°¸è¿œå®‰é™ã€‚"
        ];

        function giveNote() {
            if(currentMode === 'breath') return;
            spirit.style.transform = "scale(1.2) rotate(5deg)";
            const randomNote = notes[Math.floor(Math.random()*notes.length)];
            showMessage(`(ä»èƒŒåæ‹¿å‡ºä¸€å¼ çº¸æ¡ç»™ ${Memory.getUserName()})ï¼š\n"${randomNote}"`);
            blushes.forEach(b => b.classList.add('shy'));
            setTimeout(() => {
                if(currentMode === 'idle') spirit.style.transform = "";
                blushes.forEach(b => b.classList.remove('shy'));
            }, 2000);
        }

        // --- åŸºç¡€é€»è¾‘ä¿æŒ ---
        function saveName() {
            const val = document.getElementById('name-input').value.trim();
            if(val) {
                Memory.setUserName(val);
                document.getElementById('onboarding').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('onboarding').style.display = 'none';
                    welcomeUser();
                }, 1000);
            }
        }

        function welcomeUser() {
            Memory.refresh();
            const n = Memory.getUserName();
            const greets = [`${n}ï¼Œä½ å›æ¥å•¦ã€‚`, window.currentTimeGreeting, `ä»Šå¤©çš„å®ˆæŠ¤æ˜Ÿä¹Ÿåœ¨é—ªé—ªå‘å…‰å‘¢ã€‚` ];
            showMessage(greets[Math.floor(Math.random()*greets.length)]);
        }

        function showMessage(txt) {
            bubble.style.opacity = 0;
            setTimeout(() => { bubble.innerText = txt; bubble.style.opacity = 1; }, 300);
        }

        function switchMode(mode, el) {
            clearTimeout(breathTimer);
            currentMode = mode;
            spirit.className = 'spirit';
            spirit.style.transform = ""; 
            ventArea.style.display = 'none';
            mouth.classList.remove('open');
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            el.classList.add('active');

            if(mode === 'idle') welcomeUser();
            else if(mode === 'breath') runBreath();
            else if(mode === 'vent') {
                ventArea.style.display = 'flex';
                showMessage(`æŠŠåå¿ƒæƒ…äº¤ç»™å›¢å­ï¼Œæˆ‘ä¼šå¸® ${Memory.getUserName()} æ¶ˆåŒ–ã€‚`);
            }
            else if(mode === 'sleep') {
                document.body.style.background = "#020617";
                spirit.classList.add('sleeping');
                showMessage(`ç¡ä¸ªå¥½è§‰å§ï¼Œ${Memory.getUserName()}ã€‚æ™šå®‰ã€‚`);
            }
        }

        function runBreath() {
            if(currentMode !== 'breath') return;
            const cycle = () => {
                if(currentMode !== 'breath') return;
                showMessage("æ…¢æ…¢å¸æ°”...");
                spirit.className = 'spirit breath-inhale';
                breathTimer = setTimeout(() => {
                    if(currentMode !== 'breath') return;
                    showMessage("åœä½ä¸€ä¼šå„¿...");
                    spirit.className = 'spirit breath-hold';
                    breathTimer = setTimeout(() => {
                        if(currentMode !== 'breath') return;
                        showMessage("ç¼“ç¼“å‘¼æ°”...");
                        spirit.className = 'spirit breath-exhale';
                        breathTimer = setTimeout(cycle, 6000);
                    }, 2000);
                }, 4000);
            };
            cycle();
        }

        function startSwallowing() {
            const input = document.getElementById('vent-input');
            const txt = input.value.trim();
            if(!txt) return;
            mouth.classList.add('open');
            eyes.forEach(e => e.classList.add('happy'));
            blushes.forEach(b => b.classList.add('shy'));
            showMessage("å•Šâ€”â€”å‘œï¼");
            const rect = input.getBoundingClientRect();
            const cloud = document.createElement('div');
            cloud.className = 'trouble-cloud'; cloud.innerText = txt;
            cloud.style.left = rect.left+'px'; cloud.style.top = rect.top+'px';
            document.body.appendChild(cloud);
            setTimeout(() => {
                const sRect = spirit.getBoundingClientRect();
                cloud.style.left = (sRect.left + sRect.width/2 - 20) + 'px';
                cloud.style.top = (sRect.top + sRect.height/2 + 20) + 'px';
                cloud.style.transform = "scale(0.1)"; cloud.style.opacity = "0";
            }, 50);
            setTimeout(() => {
                cloud.remove(); input.value = "";
                mouth.classList.remove('open');
                spirit.classList.add('munching');
                setTimeout(() => {
                    spirit.classList.remove('munching');
                    const stars = Memory.addStar();
                    Memory.refresh();
                    showMessage(`å¥½åƒï¼å·²ç»å…¨éƒ¨æ¶ˆåŒ–å•¦ã€‚è¿™æ˜¯ç¬¬ ${stars} é¢—å®ˆæŠ¤æ˜Ÿã€‚`);
                    createBurst();
                    setTimeout(() => {
                        eyes.forEach(e => e.classList.remove('happy'));
                        blushes.forEach(b => b.classList.remove('shy'));
                    }, 2000);
                }, 1200);
            }, 850);
        }

        function handlePet() {
            if(currentMode === 'breath') return;
            spirit.style.transform = "scale(1.1) translateY(-10px)";
            blushes.forEach(b => b.classList.add('shy'));
            showMessage(`æ‘¸æ‘¸ ${Memory.getUserName()} çš„å¤´ï¼Œæš–æš–çš„ã€‚`);
            setTimeout(() => { 
                if(currentMode !== 'breath') spirit.style.transform = ""; 
                blushes.forEach(b => b.classList.remove('shy'));
            }, 800);
        }

        document.addEventListener('mousemove', (e) => {
            if(currentMode === 'sleep' || currentMode === 'breath') return;
            const rect = spirit.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
            eyes.forEach(eye => {
                if(!eye.classList.contains('happy'))
                    eye.style.transform = `translate(${Math.cos(angle)*4}px, ${Math.sin(angle)*4}px)`;
            });
            const rx = -(e.clientY - centerY) / window.innerHeight * 15;
            const ry = (e.clientX - centerX) / window.innerWidth * 15;
            document.getElementById('tilt-box').style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
        });

        function createStars() {
            const c = document.getElementById('stars-container');
            for(let i=0; i<40; i++) {
                const s = document.createElement('div');
                s.style.position = 'absolute';
                s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
                s.style.width = '2px'; s.style.height = '2px'; s.style.background = 'white';
                s.style.opacity = Math.random()*0.5;
                c.appendChild(s);
            }
        }

        function createBurst() {
            for(let i=0; i<8; i++) {
                const p = document.createElement('div');
                p.innerText = "âœ¨"; p.style.position = "fixed";
                p.style.left = "50%"; p.style.top = "60%";
                p.style.transition = "1.5s ease-out";
                document.body.appendChild(p);
                const a = Math.random() * Math.PI * 2;
                setTimeout(() => {
                    p.style.transform = `translate(${Math.cos(a)*150}px, ${Math.sin(a)*150}px) scale(0)`;
                    p.style.opacity = 0;
                }, 50);
                setTimeout(() => p.remove(), 1000);
            }
        }
    </script>
</body>
</html>
