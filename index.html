<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç™½å›¢å­ Companion</title>
    <style>
        :root {
            --spirit-main: #ffffff;
            --mouth-color: #475569;
            --blush-color: #fecaca;
            --bg-color: #0f172a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-touch-callout: none; }

        html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; position: fixed; overscroll-behavior: none; }

        body {
            background: var(--bg-color);
            color: white;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 1.5s ease;
        }

        #stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* ---------------- UI ---------------- */
        .top-ui { position: absolute; top: 20px; width: 90%; display: flex; justify-content: space-between; align-items: center; z-index: 500; }
        .memory-badge { font-size: 0.75rem; opacity: 0.8; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 12px; backdrop-filter: blur(5px); }
        .right-tools { display: flex !important; flex-direction: row !important; gap: 12px; align-items: center; }
        .tool-container { position: relative; }
        .tool-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; border: 1px solid rgba(255,255,255,0.2); }

        .pop-menu { position: absolute; top: 55px; right: 0; background: white; color: #1e293b; padding: 12px; border-radius: 18px; display: none; flex-direction: column; gap: 8px; min-width: 190px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 1000; }
        .menu-item { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; border-radius: 12px; transition: 0.2s; font-size: 0.95rem; white-space: nowrap; text-decoration: none; color: #1e293b; }

        /* ---------------- èˆå° ---------------- */
        .main-stage { position: relative; flex: 1; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; padding-bottom: 80px; }
        .speech-bubble { background: rgba(255, 255, 255, 0.95); color: #1e293b; padding: 15px 25px; border-radius: 25px; font-size: 1rem; margin-bottom: 60px; min-height: 64px; max-width: 85%; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: relative; transition: 0.3s; line-height: 1.5; z-index: 20; }
        .speech-bubble::after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid white; }

        #focus-timer { font-size: 2.8rem; font-weight: 200; margin-bottom: 20px; letter-spacing: 2px; display: none; }

        /* ---------------- å›¢å­åˆ†å±‚ç»“æ„ ---------------- */
        .tilt-box { position: relative; transition: transform 0.2s ease-out; perspective: 600px; z-index: 10; }
        .breath-wrap { transition: transform 0.6s ease-in-out; position: relative; }
        
        /* åŠ¨ç”»ç±» */
        .breath-inhale { transition: transform 4s ease-in-out !important; transform: scale(1.6) !important; }
        .breath-hold { transition: transform 2s ease-in-out !important; transform: scale(1.6) !important; }
        .breath-exhale { transition: transform 6s ease-in-out !important; transform: scale(1.0) !important; }
        .is-focusing-wrap { transform: scale(0.85); }
        @keyframes sleep-anim { 0%, 100% { transform: scale(0.95); opacity: 0.7; } 50% { transform: scale(1.02); opacity: 0.9; } }
        .is-sleeping-wrap { animation: sleep-anim 5s ease-in-out infinite !important; }

        .spirit {
            width: 135px; height: 115px; background: var(--spirit-main); border-radius: 50% 50% 45% 45%;
            position: relative; box-shadow: 0 0 35px rgba(255,255,255,0.2); cursor: pointer;
            transform-origin: center bottom; touch-action: none; transition: background 0.5s, box-shadow 0.5s;
        }

        /* åŠ¨æ€åŠ¨ç”» */
        @keyframes munch { 0%, 100% { transform: scale(1, 1); } 50% { transform: scale(1.18, 0.88); } }
        @keyframes munch-fast { 0%, 100% { transform: scale(1, 1); } 50% { transform: scale(1.3, 0.75); } } /* ç”Ÿæ°”åš¼ */
        @keyframes swallow-gulp { 0% { transform: scale(1.18, 0.88); } 50% { transform: scale(0.85, 1.25) translateY(-25px); } 100% { transform: scale(1, 1) translateY(0); } }
        @keyframes spirit-shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } } /* æ‘‡å¤´ */

        .munching { animation: munch 0.4s infinite !important; }
        .munching-fast { animation: munch-fast 0.2s infinite !important; }
        .swallowing { animation: swallow-gulp 0.6s ease-out forwards !important; }
        .shaking { animation: spirit-shake 0.3s infinite !important; }

        /* äº”å®˜ä¸è¡¨æƒ… */
        .face { position: absolute; top: 45px; width: 100%; pointer-events: none; transition: 0.3s; }
        .eyes { display: flex; justify-content: center; gap: 35px; margin-bottom: 8px; }
        .eye { width: 8px; height: 8px; background: #334155; border-radius: 50%; transition: 0.5s; position: relative; }
        
        .eye.petting { height: 3px; border-radius: 10px; transform: scaleX(1.2); }
        .eye.happy { background: transparent !important; width: 10px; height: 10px; border-top: 3px solid #334155; border-radius: 50% 50% 0 0; transform: translateY(2px) !important; }
        .eye.focusing { transform: scaleY(0.4) !important; border-radius: 2px; }
        .eye.sleeping { transform: scaleY(0.1) !important; height: 2px; width: 10px; border-radius: 0; opacity: 0.5; }
        .eye.sad { transform: translateY(2px) rotate(15deg); height: 4px; border-radius: 10px; } /* å¿§éƒçœ¼ */
        .eye.angry { width: 10px; height: 3px; background: #334155; border-radius: 10px; transform: rotate(-20deg); } /* æ°”é¼“é¼“ */

        .blush-container { position: absolute; top: 12px; width: 100%; display: flex; justify-content: center; gap: 55px; opacity: 0.35; transition: 0.5s; }
        .blush { width: 18px; height: 10px; background: var(--blush-color); border-radius: 50%; filter: blur(2px); }
        .blush.shy { opacity: 1; transform: scale(1.4); background: #fca5a5; }

        .mouth {
            position: absolute; top: 32px; left: 50%; transform: translateX(-50%);
            width: 14px; height: 7px; border-bottom: 2.5px solid var(--mouth-color);
            border-radius: 0 0 10px 10px; transition: 0.3s;
        }
        .mouth.open { top: 22px; width: 28px; height: 28px; background: #334155; border: none; border-radius: 50%; box-shadow: inset 0 -6px 0 #fca5a5; }

        /* ---------------- å…¶ä»– UI ---------------- */
        .action-btn { background: white; color: #1e293b; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .dock { position: fixed; bottom: 30px; display: flex; gap: 15px; background: rgba(255,255,255,0.08); padding: 10px 20px; border-radius: 40px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .dock-item { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 1.3rem; transition: 0.3s; opacity: 0.6; }
        .dock-item.active { opacity: 1; background: rgba(255,255,255,0.2); }
        #onboarding { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        .input-box { width: 100%; max-width: 280px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; color: white; padding: 12px; font-size: 1rem; text-align: center; margin-bottom: 15px; }

        .gift-cloud, .trouble-cloud { position: fixed; padding: 8px 15px; border-radius: 20px; z-index: 2000; transition: all 1s cubic-bezier(0.6, -0.28, 0.735, 0.045); pointer-events: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="stars-container"></div>
    
    <div class="top-ui">
        <div class="memory-badge" id="badge-ui">...</div>
        <div class="right-tools">
            <div class="tool-container">
                <div class="tool-btn" onclick="toggleMenu('bag-menu')">ğŸ’</div>
                <div id="bag-menu" class="pop-menu">
                    <a href="https://www.instagram.com/advicewithanson/" target="_blank" class="menu-item" style="color:#f43f5e; font-weight:bold;" onclick="teleportLog()">âœ¨ Anson çš„å°ç«™</a>
                    <div class="menu-item" onclick="giveGift('ğŸª', 'å°é¥¼å¹²')">ğŸª æŠ•å–‚é¥¼å¹²</div>
                    <div class="menu-item" onclick="giveGift('ğŸµ', 'çƒ­èŒ¶')">ğŸµ å€’æ¯çƒ­èŒ¶</div>
                    <div class="menu-item" onclick="startFocus()">ğŸ“– é™ªæˆ‘ä¸“æ³¨</div>
                </div>
            </div>
            <div class="tool-container">
                <div class="tool-btn" onclick="toggleMenu('note-menu')">âœ‰ï¸</div>
                <div id="note-menu" class="pop-menu">
                    <div class="menu-item" onclick="giveNote()">âœ‰ï¸ æŠ½å¼ çº¸æ¡</div>
                </div>
            </div>
        </div>
    </div>

    <div id="onboarding">
        <h2 style="margin-bottom: 30px; font-weight: 300;">ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯å°ç™½å›¢å­ã€‚<br>æˆ‘è¯¥æ€ä¹ˆç§°å‘¼ä½ å‘¢ï¼Ÿ</h2>
        <input type="text" id="name-input" class="input-box" placeholder="ä½ çš„åå­—..." maxlength="8">
        <button class="action-btn" onclick="saveName()">æˆ‘ä»¬è¦ä¸€ç›´åœ¨ä¸€èµ·å“¦</button>
    </div>

    <div class="main-stage">
        <div id="focus-timer">25:00</div>
        <div class="speech-bubble" id="bubble">...</div>

        <div id="vent-area" style="display: none; flex-direction: column; align-items: center; margin-bottom: 40px; z-index: 100;">
            <input type="text" id="vent-input" class="input-box" placeholder="æŠŠçƒ¦æ¼å†™åœ¨è¿™é‡Œ..." autocomplete="off">
            <button class="action-btn" onclick="startSwallowing()">äº¤ç»™å›¢å­åƒæ‰</button>
        </div>

        <div class="tilt-box" id="tilt-box">
            <div class="breath-wrap" id="breath-wrap">
                <div class="spirit" id="spirit" onclick="handleSpiritClick()">
                    <div class="face" id="face">
                        <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
                        <div class="blush-container"><div class="blush"></div><div class="blush"></div></div>
                        <div class="mouth" id="mouth"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="exit-focus" class="action-btn" style="position: fixed; bottom: 100px; display: none; z-index: 1000;" onclick="stopFocus()">ä¸å­¦å•¦ï¼ŒæŠ±æŠ±æˆ‘</button>

    <div class="dock" id="main-dock">
        <div class="dock-item active" onclick="switchMode('idle', this)">ğŸ </div>
        <div class="dock-item" onclick="switchMode('breath', this)">ğŸŒ¬ï¸</div>
        <div class="dock-item" onclick="switchMode('vent', this)">ğŸ•³ï¸</div>
        <div class="dock-item" onclick="switchMode('sleep', this)">ğŸŒ™</div>
    </div>

    <script>
        const Memory = {
            init: () => { if(!localStorage.getItem('spirit_meet')) localStorage.setItem('spirit_meet', Date.now()); },
            get: (k) => localStorage.getItem('spirit_'+k),
            set: (k, v) => localStorage.setItem('spirit_'+k, v),
            addStar: () => { let s = parseInt(Memory.get('stars')||0)+1; Memory.set('stars', s); return s; },
            refresh: () => {
                const n = Memory.get('name'); if(!n) return;
                const days = Math.floor((Date.now() - Memory.get('meet'))/86400000)+1;
                document.getElementById('badge-ui').innerHTML = `${n}çš„é™ªä¼´è€…<br>é™ªä¼´ ${days} å¤© | æ˜Ÿæ˜Ÿ ${Memory.get('stars')||0}`;
            }
        };

        const dom = {
            spirit: document.getElementById('spirit'),
            bWrap: document.getElementById('breath-wrap'),
            tilt: document.getElementById('tilt-box'),
            bubble: document.getElementById('bubble'),
            mouth: document.getElementById('mouth'),
            face: document.getElementById('face'),
            vent: document.getElementById('vent-area'),
            eyes: document.querySelectorAll('.eye'),
            blushes: document.querySelectorAll('.blush')
        };

        let currentMode = 'idle', breathTimer = null, focusInt = null, isPetting = false, petStartPos = {x:0, y:0};

        window.onload = () => { Memory.init(); createStars(); updateTimeTheme(); if(!Memory.get('name')) document.getElementById('onboarding').style.display='flex'; else welcomeUser(); };

        function showMessage(txt) {
            dom.bubble.style.opacity = 0; dom.bubble.style.transform = "translateY(10px)";
            setTimeout(() => { dom.bubble.innerText = txt; dom.bubble.style.opacity = 1; dom.bubble.style.transform = "translateY(0)"; }, 300);
        }

        // --- æ ¸å¿ƒè¿›åŒ–ï¼šå…³é”®è¯æ„Ÿåº”é€»è¾‘ ---
        function startSwallowing() {
            const input = document.getElementById('vent-input');
            const val = input.value.trim();
            if(!val) return;
            input.value = "";

            const name = Memory.get('name');
            let reactionType = "normal"; // normal, sad, doubt, angry, physical, love

            // å…³é”®è¯åº“
            if (/ç´¯|å“­|éš¾è¿‡|å‹åŠ›|ç–¼|ç¢/.test(val)) reactionType = "sad";
            else if (/ç¬¨|å·®|æ²¡ç”¨|å¤±è´¥|ä¸‘|é”™/.test(val)) reactionType = "doubt";
            else if (/åŠ ç­|è€ƒè¯•|è€å¸ˆ|è€æ¿|é¢†å¯¼|ä½œä¸š/.test(val)) reactionType = "angry";
            else if (/é¥¿|å›°|æ¸´|ç¡/.test(val)) reactionType = "physical";
            else if (/å–œæ¬¢|çˆ±|å›¢å­/.test(val)) reactionType = "love";

            // ç¬¬ä¸€é˜¶æ®µï¼šæ„Ÿåº”æ–‡å­—
            dom.mouth.classList.add('open');
            
            if (reactionType === "sad") {
                dom.eyes.forEach(e => e.classList.add('sad'));
                showMessage(`(å¿ƒç–¼åœ°çœ‹ç€ä½ ) ${name}ï¼Œç´¯äº†å°±é åœ¨æˆ‘èº«ä¸Šæ­‡ä¸€æ­‡å§...`);
            } else if (reactionType === "doubt") {
                dom.spirit.classList.add('shaking');
                showMessage(`(ç”¨åŠ›æ‘‡å¤´) ä¸è®¸è¿™æ ·è¯´ï¼ä½ æ˜¯å›¢å­å¿ƒä¸­æœ€æ£’çš„ ${name}ï¼`);
            } else if (reactionType === "angry") {
                dom.eyes.forEach(e => { e.className = 'eye'; e.classList.add('angry'); });
                showMessage(`(æ°”é¼“é¼“) è¿™ç§åä¸œè¥¿ï¼Œè®©å›¢å­å¤§å£åƒæ‰æ¶ˆç­å®ƒï¼å•Šâ€”â€”`);
            } else if (reactionType === "physical") {
                showMessage(`(æ­ªå¤´æƒ³äº†æƒ³) é‚£å›¢å­é™ªä½ ä¸€èµ·å»è¡¥å……èƒ½é‡å¥½ä¸å¥½ï¼Ÿ`);
            } else if (reactionType === "love") {
                dom.spirit.style.background = "#ffd1dc";
                dom.blushes.forEach(b => b.classList.add('shy'));
                showMessage(`(è„¸çº¢åˆ°å†’çƒŸ) å˜¿å˜¿... å›¢å­ä¹Ÿæœ€å–œæ¬¢ ${name} å•¦ï¼`);
            } else {
                dom.eyes.forEach(e => e.classList.add('happy'));
                showMessage("å•Šâ€”â€”å‘œï¼å…¨åƒæ‰ï¼çƒ¦æ¼ä¸è§å’¯ï¼");
            }

            // ç¬¬äºŒé˜¶æ®µï¼šåš¼åš¼é€»è¾‘
            setTimeout(() => {
                dom.mouth.classList.remove('open');
                if (reactionType === "angry") dom.spirit.classList.add('munching-fast');
                else dom.spirit.classList.add('munching');

                setTimeout(() => {
                    dom.spirit.classList.remove('munching', 'munching-fast', 'shaking');
                    dom.spirit.classList.add('swallowing');
                    
                    setTimeout(() => {
                        dom.spirit.classList.remove('swallowing');
                        dom.spirit.style.background = "";
                        const s = Memory.addStar(); Memory.refresh();
                        
                        if (reactionType === "doubt") showMessage(`çœ‹ï¼Œçƒ¦æ¼è¢«æˆ‘å“è·‘å•¦ï¼å­˜ä¸‹ç¬¬ ${s} é¢—æ˜Ÿæ˜Ÿã€‚`);
                        else if (reactionType === "love") showMessage(`å˜¿å˜¿ï¼Œè¿™é¢—çˆ±å¿ƒå˜æˆç¬¬ ${s} é¢—å®ˆæŠ¤æ˜Ÿå•¦ã€‚`);
                        else showMessage(`å¥½å•¦ï¼Œèˆ’æœå¤šäº†ã€‚æ”¶é›†åˆ°äº†ç¬¬ ${s} é¢—å®ˆæŠ¤æ˜Ÿã€‚`);
                        
                        createBurst();
                        setTimeout(() => dom.eyes.forEach(e => e.className = 'eye'), 1000);
                    }, 600);
                }, 2000);
            }, 1000);
        }

        // --- å…¶ä»–åŸæœ‰åŠŸèƒ½é€»è¾‘ ---
        function switchMode(mode, el) {
            clearTimeout(breathTimer); currentMode = mode;
            dom.bWrap.className = 'breath-wrap'; dom.spirit.className = 'spirit'; dom.spirit.style.transform = ""; dom.face.style.transform = "";
            dom.vent.style.display = 'none'; dom.bubble.style.opacity = 1;
            dom.eyes.forEach(e => e.className = 'eye'); dom.mouth.className = 'mouth';
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active')); el.classList.add('active');
            if(mode !== 'sleep') updateTimeTheme();
            if(mode === 'idle') welcomeUser();
            else if(mode === 'breath') runBreathCycle();
            else if(mode === 'vent') { dom.vent.style.display = 'flex'; showMessage("æŠŠçƒ¦æ¼å†™åœ¨è¿™é‡Œï¼Œæˆ‘ä¼šåŠªåŠ›åƒæ‰å®ƒçš„ï¼"); }
            else if(mode === 'sleep') enterSleep();
        }

        function enterSleep() { document.body.style.background = "#020617"; dom.bWrap.classList.add('is-sleeping-wrap'); dom.eyes.forEach(e => e.classList.add('sleeping')); showMessage("æ™šå®‰ã€‚å®‰å¿ƒç¡å§... å‘¼..."); setTimeout(() => { if(currentMode === 'sleep') dom.bubble.style.opacity = 0; }, 4000); }
        function handleSpiritClick() { if(currentMode === 'sleep') { dom.bubble.style.opacity = 1; showMessage(`å””... ${Memory.get('name')}... åšä¸ªå¥½æ¢¦... ( Ë˜Ï‰Ë˜ )`); setTimeout(() => { if(currentMode === 'sleep') dom.bubble.style.opacity = 0; }, 3000); } }
        function runBreathCycle() { if(currentMode !== 'breath') return; const step = () => { if(currentMode !== 'breath') return; showMessage("æ…¢æ…¢å¸æ°”..."); dom.bWrap.className = 'breath-wrap breath-inhale'; breathTimer = setTimeout(() => { if(currentMode !== 'breath') return; showMessage("åœä½ä¸€ä¼šå„¿..."); dom.bWrap.className = 'breath-wrap breath-hold'; breathTimer = setTimeout(() => { if(currentMode !== 'breath') return; showMessage("ç¼“ç¼“å‘¼æ°”..."); dom.bWrap.className = 'breath-wrap breath-exhale'; breathTimer = setTimeout(step, 6000); }, 2000); }, 4000); }; step(); }
        function startFocus() { toggleMenu('bag-menu'); currentMode = 'focus'; document.getElementById('main-dock').style.display='none'; document.getElementById('focus-timer').style.display='block'; document.getElementById('exit-focus').style.display='block'; dom.bWrap.classList.add('is-focusing-wrap'); dom.eyes.forEach(e => e.classList.add('focusing')); showMessage("æˆ‘ä¼šä¹–ä¹–é™ªç€ä½ çš„ã€‚åŠ æ²¹å“¦ï¼"); let time = 25*60; focusInt = setInterval(() => { time--; let m = Math.floor(time/60), s = time%60; document.getElementById('focus-timer').innerText = `${m}:${s < 10?'0'+s:s}`; if(time <= 0) stopFocus(true); }, 1000); }
        function stopFocus(fin = false) { clearInterval(focusInt); document.getElementById('main-dock').style.display='flex'; document.getElementById('focus-timer').style.display='none'; document.getElementById('exit-focus').style.display='none'; currentMode = 'idle'; switchMode('idle', document.querySelector('.dock-item')); if(fin) { showMessage("25åˆ†é’Ÿåˆ°å•¦ï¼ä½ çœŸæ£’ï¼"); createBurst(); } }
        function giveGift(emoji, name) { toggleMenu('bag-menu'); showMessage(`${Memory.get('name')} é€äº†æˆ‘${name}ï¼`); dom.mouth.classList.add('open'); dom.eyes.forEach(e => e.classList.add('happy')); setTimeout(() => { dom.spirit.classList.add('munching'); setTimeout(() => { dom.spirit.classList.remove('munching'); dom.mouth.classList.remove('open'); setTimeout(() => dom.eyes.forEach(e => e.className = 'eye'), 1000); }, 2000); }, 1000); }
        function giveNote() { toggleMenu('note-menu'); const ns = ["ä½ å·²ç»å¾ˆæ£’äº†ã€‚", "å…è®¸è‡ªå·±åœä¸‹æ¥ã€‚", "ä»Šå¤©è¾›è‹¦äº†ã€‚", "æˆ‘ä¼šä¸€ç›´é™ªç€ä½ ã€‚", "è®°å¾—å–å£æ°´å‘€ã€‚", "æ˜å¤©åˆæ˜¯æ–°çš„ä¸€é¡µã€‚"]; showMessage(`(é€’çº¸æ¡)ï¼š"${ns[Math.floor(Math.random()*ns.length)]}"`); }
        function toggleMenu(id) { const m = document.getElementById(id); const open = m.style.display==='flex'; document.querySelectorAll('.pop-menu').forEach(p=>p.style.display='none'); m.style.display=open?'none':'flex'; }
        function saveName() { const n = document.getElementById('name-input').value.trim(); if(n) { Memory.set('name', n); document.getElementById('onboarding').style.display='none'; welcomeUser(); } }
        function welcomeUser() { Memory.refresh(); showMessage(`${Memory.get('name')}ï¼Œä½ å›æ¥å•¦ã€‚`); }
        function teleportLog() { showMessage(`å¥½å“’ï¼å¸¦ ${Memory.get('name')} å»æ‰¾æ¸©æš–å»ºè®®å’¯...`); toggleMenu('bag-menu'); }
        function updateTimeTheme() { const h = new Date().getHours(); let b = "linear-gradient(180deg, #0f172a 0%, #1e293b 100%)"; if(h>=5 && h<9) b = "linear-gradient(180deg, #ff9a9e 0%, #fad0c4 100%)"; else if(h>=9 && h<17) b = "linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%)"; else if(h>=17 && h<20) b = "linear-gradient(180deg, #f6d365 0%, #fda085 100%)"; document.body.style.background = b; }
        function createStars() { const c = document.getElementById('stars-container'); for(let i=0; i<30; i++) { const s = document.createElement('div'); s.style.position='absolute'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; s.style.width='2px'; s.style.height='2px'; s.style.background='white'; s.style.opacity=Math.random()*0.5; c.appendChild(s); } }
        function createBurst() { for(let i=0; i<10; i++) { const p = document.createElement('div'); p.innerText="âœ¨"; p.style.position="fixed"; p.style.left="50%"; p.style.top="60%"; p.style.transition="1.5s ease-out"; document.body.appendChild(p); const a=Math.random()*Math.PI*2; setTimeout(() => { p.style.transform=`translate(${Math.cos(a)*150}px, ${Math.sin(a)*150}px) scale(0)`; p.style.opacity=0; }, 50); setTimeout(()=>p.remove(), 1500); } }

        // --- æ‰æ‰äº¤äº’é€»è¾‘ ---
        const startPet = (e, x, y) => { if(e.cancelable) e.preventDefault(); if(currentMode !== 'idle') return; isPetting = true; petStartPos = {x, y}; dom.eyes.forEach(e => e.classList.add('petting')); dom.blushes.forEach(b => b.classList.add('shy')); dom.spirit.style.transition = "none"; };
        const stopPet = (e, x, y) => { if(!isPetting) return; isPetting = false; const dist = Math.sqrt(Math.pow(x - petStartPos.x, 2) + Math.pow(y - petStartPos.y, 2)); if(dist < 15) handlePoke(); dom.eyes.forEach(e => e.classList.remove('petting')); dom.blushes.forEach(b => b.classList.remove('shy')); dom.spirit.style.transition = "transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; dom.spirit.style.transform = ""; dom.face.style.transform = ""; };
        const handlePoke = () => { dom.spirit.style.transition = "transform 0.1s ease-out"; dom.spirit.style.transform = "scale(0.85)"; setTimeout(() => { dom.spirit.style.transition = "transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; dom.spirit.style.transform = "scale(1.1) translateY(-15px)"; setTimeout(() => { if(!isPetting) dom.spirit.style.transform = ""; }, 400); }, 100); };
        const movePet = (e, x, y) => { if(!isPetting) return; if(e.cancelable) e.preventDefault(); const r = dom.spirit.getBoundingClientRect(); const dx = (x - (r.left + r.width/2))/10, dy = (y - (r.top + r.height/2))/10; dom.spirit.style.transform = `translate(${dx}px, ${dy}px) skew(${dx*0.4}deg) scale(${1-Math.abs(dy)/220}, ${1+Math.abs(dy)/220})`; dom.face.style.transform = `translate(${dx*0.7}px, ${dy*0.7}px)`; };
        dom.spirit.addEventListener('mousedown', (e) => startPet(e, e.clientX, e.clientY));
        window.addEventListener('mouseup', (e) => stopPet(e, e.clientX, e.clientY));
        window.addEventListener('mousemove', (e) => movePet(e, e.clientX, e.clientY));
        dom.spirit.addEventListener('touchstart', (e) => startPet(e, e.touches[0].clientX, e.touches[0].clientY), {passive: false});
        window.addEventListener('touchend', (e) => stopPet(e, e.changedTouches[0].clientX, e.changedTouches[0].clientY), {passive: false});
        window.addEventListener('touchmove', (e) => movePet(e, e.touches[0].clientX, e.touches[0].clientY), {passive: false});
    </script>
</body>
</html>
